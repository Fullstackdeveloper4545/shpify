{% comment %}
  Displays the latest promo products/cards on product pages.
{% endcomment %}

{%- assign promo_collection = section.settings.promo_collection -%}
{%- if promo_collection == blank -%}
  {%- assign promo_collection = collections['promocoes'] -%}
{%- endif -%}

{%- if promo_collection == blank or promo_collection.products_count == 0 -%}
  {%- assign promo_collection = collections['all'] -%}
{%- endif -%}

{%- assign promo_products = promo_collection.products | default: empty | slice: 0, 3 -%}

{% if promo_products != empty %}
  <section class="home-promos section-space">
    <div class="page-width">
      {% if section.settings.heading != blank %}
        <div class="home-categories__header" style="margin-bottom: 18px;">
          <h2 class="home-categories__title">{{ section.settings.heading | escape }}</h2>
        </div>
      {% endif %}
      <div class="home-promos__grid">
        {% for product in promo_products %}
          {% assign promo_image = '' %}
          {% if product.featured_media %}
            {% assign promo_image = product.featured_media | image_url: width: 1200 %}
          {% elsif product.images.first %}
            {% assign promo_image = product.images.first | image_url: width: 1200 %}
          {% endif %}

          {% assign promo_code_raw = product.metafields.custom.promo_code | default: '' %}
          {% assign promo_code_clean = promo_code_raw | strip %}
          {% assign promo_code_display = promo_code_clean | escape %}

          <div class="home-promos__card promo-card{% if promo_image == '' %} promo-card--no-image{% endif %}" data-promo-code="{{ promo_code_display }}">
            {% if promo_image != '' %}
              <img src="{{ promo_image }}" alt="{{ product.title | escape }}" loading="lazy" style="width:100%;height:100%;object-fit:cover;">
            {% else %}
              <div style="width:100%;height:100%;background:#f2f2f2;display:flex;align-items:center;justify-content:center;font-weight:600;">
                {{ product.title | escape }}
              </div>
            {% endif %}
            <div class="home-promos__content">
              <div>
                <h3>{{ product.title | escape }}</h3>
                {% if promo_code_clean != blank %}
                  <p>{{ promo_code_display }}</p>
                {% endif %}
              </div>
              <a class="gb-btn gb-btn--ghost" href="{{ product.url }}">Aproveite já</a>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </section>
{% endif %}

{% schema %}
{
  "name": "Promo codes (produto)",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Título",
      "default": "Promoções em destaque"
    },
    {
      "type": "collection",
      "id": "promo_collection",
      "label": "Coleção de promoções",
      "info": "Se vazio, usa a coleção com handle 'promocoes', senão 'all'."
    }
  ],
  "presets": [
    {
      "name": "Promo codes (produto)"
    }
  ]
}
{% endschema %}
